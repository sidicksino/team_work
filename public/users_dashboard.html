<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tableau de Bord</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"> 
</head>
<body>
  <div class="sidebar">
    <div class="user-avatar">S</div>
    <div class="user-info">
      <h3>Sidick</h3>
      <p>Client depuis 2024</p>
    </div>
  </div>

  <div class="main-content">
    <!-- Section Commandes -->
    <div class="dashboard-section active" id="orders">
      <div class="section-header">
        <h2><i class="fas fa-box"></i> Mes Commandes</h2>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nom</th>
              <th>Date</th>
              <th>Total</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="orders">
            <!-- Les commandes seront injectÃ©es ici -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Fonction pour charger les commandes
    async function loadOrders() {
      try {
        const response = await fetch("/admin/commandes", {
          credentials: 'include' // ðŸ‘ˆ Essentiel pour envoyer le cookie de session
        });

        const orders = await response.json();
        const tbody = document.querySelector('#orders');
        tbody.innerHTML = '';

        if (orders.length === 0) {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="6" class="text-center">Aucune commande trouvÃ©e</td>`;
          tbody.appendChild(row);
          return;
        }

        orders.forEach(order => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${order.id}</td>
            <td>${order.prenom} ${order.nom}</td>
            <td>${new Date(order.date_commande).toLocaleDateString()}</td>
            <td>${parseFloat(order.total).toFixed(2)} â‚¬</td>
            <td><span class="status status-shipped">En transit</span></td>
            <td><button class="btn btn-outline">Suivre</button></td>
          `;
          tbody.appendChild(row);
        });
      } catch (error) {
        console.error('Erreur lors du chargement des commandes :', error);
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="6" class="text-center text-red-500">Erreur de chargement</td>`;
        tbody.appendChild(row);
      }
    }

    // Fonction pour charger les informations utilisateur
    async function loadUserInfo() {
      try {
        const response = await fetch("/api/user", {
          credentials: "include"
        });
        const data = await response.json();

        if (data.loggedIn) {
          const user = data.user;
          document.querySelector(".user-info h3").textContent = user.username;
          document.querySelector(".user-info p").textContent = `Client depuis ${new Date().getFullYear()}`;
          document.querySelector(".user-avatar").textContent = user.username.charAt(0).toUpperCase();
        } else {
          window.location.href = "/";
        }
      } catch (error) {
        console.error("Erreur lors du chargement de l'utilisateur :", error);
        window.location.href = "/";
      }
    }

    // Charger les donnÃ©es au dÃ©marrage
    document.addEventListener("DOMContentLoaded", () => {
      loadUserInfo();
      
      const ordersSection = document.getElementById("orders");
      if (ordersSection && ordersSection.closest(".dashboard-section").classList.contains("active")) {
        loadOrders();
      }

      document.querySelectorAll(".menu-item").forEach(item => {
        item.addEventListener("click", () => {
          if (item.getAttribute("data-section") === "orders") {
            loadOrders();
          }
        });
      });
    });
  </script>
</body>
</html>